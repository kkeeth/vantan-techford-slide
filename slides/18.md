---
theme: default
background: https://picsum.photos/1920/1080
class: text-center
highlighter: shiki
lineNumbers: true
info: |
  ## TypeScript + React ハンズオン講座
  第18回：チャットアプリ開発（画像アップロード機能編）
fonts:
  sans: "Josefin Sans"
  serif: "Noto Sans JP"
  mono: "Fira Code"

drawings:
  persist: false
transition: slide-left
title: TypeScript/React 入門講義
---

# TypeScript + React<br>ハンズオン講座

## 第18回：チャットアプリ開発<br>画像アップロード機能編

<div class="pt-12">
  <span @click="$slidev.nav.next" class="px-2 py-1 rounded cursor-pointer" hover="bg-white bg-opacity-10">
    Press Space for next page <carbon:arrow-right class="inline"/>
  </span>
</div>

<div class="abs-br m-6 flex gap-2">
  <button @click="$slidev.nav.openInEditor()" title="Open in Editor" class="text-xl slidev-icon-btn opacity-50 !border-none !hover:text-white">
    <carbon:edit />
  </button>
</div>

<style>
h1 {
  background-color: #fff;
  background-image: none;
}
</style>

---
layout: section
---

# 出席確認✋️

---
layout: default
---

# 本日の内容

<Toc minDepth="2" maxDepth="2" />

<style>
h2 {
  margin: 1rem 0;
}
</style>

## 👉️ 画像アップロード機能を実装しよう！

---
layout: section
---

# 画像アップロード機能の実装

---

# 目次

## 1. TypeScript でのファイル選択機能の実装
## 2. 型安全な画像プレビュー機能
## 3. 画像付きメッセージの投稿
## 4. 画像表示機能
## 5. ファイルサイズ制限とバリデーション

※今回は TypeScript でブラウザのファイル API を学びます．

<style>
h2 {
  margin-bottom: .5rem;
}
</style>

---

# 1. TypeScript でのファイル選択機能の実装

## 1.1 画像状態の追加

画像ファイルを管理する状態を追加します：

```tsx
const App = () => {
  const [text, setText] = useState<string>('');
  const [messages, setMessages] = useState<Message[]>([]);
  const [isPosting, setIsPosting] = useState<boolean>(false);
  const [image, setImage] = useState<File | null>(null);

  // 既存の関数...

  return (
    // 既存の JSX...
  );
}
```

<v-click>

📝 **ポイント：** `image` 状態は File オブジェクトまたは null を保持します．

</v-click>

---

## 1.2 ファイル選択ハンドラーの実装

ファイル選択時の処理を実装します：

```tsx
const handleSelectImage = (e) => {
  const file = e.target.files[0];
  if (file) {
    // ファイルタイプの検証
    if (!file.type.startsWith('image/')) {
      alert('画像ファイルを選択してください');
      return;
    }

    // ファイルサイズの検証（5MB以下）
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
      alert('ファイルサイズが大きすぎます（5MB以下にしてください）');
      return;
    }

    setImage(file);
  }
};
```

---

## 1.3 画像選択ボタンの機能追加

既存の画像選択ボタンに機能を追加します：

```tsx
<Button
  variant="outlined"
  component="label"
  startIcon={<ImageIcon />}
  sx={{
    flex: 1,
    width: { xs: '100%', sm: 'auto' },
    height: 48,
    borderRadius: 2,
    borderColor: colors.primary,
    color: colors.primary,
    backgroundColor: 'rgba(255, 255, 255, 0.8)',
    '&:hover': {
      borderColor: colors.secondary,
      backgroundColor: 'rgba(59, 130, 246, 0.04)',
    },
  }}
>
  画像を追加
  <input
    type="file"
    hidden
    accept="image/png, image/jpg, image/jpeg, image/gif"
    onChange={handleSelectImage}
  />
</Button>
```

---

# 2. 画像プレビュー機能

## 2.1 プレビュー表示の実装

選択した画像のプレビューを表示します：

```tsx
{image && (
  <Paper
    elevation={2}
    sx={{
      p: 2,
      borderRadius: 2,
      background: 'rgba(255, 255, 255, 0.8)',
      border: '1px solid rgba(59, 130, 246, 0.1)',
    }}
  >
    <Typography
      variant="body2"
      color="text.secondary"
      sx={{ mb: 1 }}
    >
      📸 画像プレビュー
    </Typography>
    <Box
      sx={{
        display: 'flex',
        justifyContent: 'center',
        width: '100%',
      }}
    >
```

---

## 2.2 プレビュー画像の表示

画像の表示部分を実装します：

<div grid="~ cols-2 gap-4">
<div>

```tsx
      <Box
        component="img"
        alt="Preview"
        src={URL.createObjectURL(image)}
        sx={{
          maxWidth: '80%',
          maxHeight: 200,
          objectFit: 'contain',
          borderRadius: 2,
          boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
        }}
      />
    </Box>
    <Box
      sx={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        mt: 2,
      }}
    >
      <Typography variant="caption" color="text.secondary">
        {image.name} ({Math.round(image.size / 1024)}KB)
      </Typography>
      <Button
        size="small"
        color="error"
        onClick={() => setImage(null)}
      >
        削除
      </Button>
    </Box>
  </Paper>
)}
```

</div>
<div>

📝 **ポイント：**
- `URL.createObjectURL()` でファイルを表示可能なURLに変換
- ファイル名とサイズを表示
- 削除ボタンでプレビューをクリア

</div>
</div>

---

# 3. 画像付きメッセージの投稿

## 3.1 投稿処理の更新

画像を含むメッセージの投稿処理を更新します：

<div grid="~ cols-2 gap-4">
<div>

```tsx
const handlePost = async (e) => {
  e.preventDefault();

  const error = validateMessage(text);
  if (error) {
    alert(error);
    return;
  }

  setIsPosting(true);

  try {
    const createdAt = new Date().toLocaleString();
    let newMessage;

    if (image) {
      const reader = new FileReader();
      reader.onload = () => {
        const imageData = reader.result;

        const messageWithImage = {
          id: Date.now(),
          text,
          image: imageData,
          date: createdAt,
        };

        setMessages((prev) => [messageWithImage, ...prev]);
      };

      reader.readAsDataURL(image);
    } else {
```

</div>
<div>

```tsx
      newMessage = {
        id: Date.now(),
        text: text.trim(),
        image: null,
        date: createdAt,
      };

      setMessages((prev) => [newMessage, ...prev]);
    }

    setImage(null);
    setText('');
  } finally {
    setIsPosting(false);
  }
};
```

📝 **FileReader API:**
- `readAsDataURL()`: ファイルを Base64 エンコードされた文字列に変換
- 非同期処理なので `onload` イベントで結果を受け取る

</div>
</div>

---

# 4. 画像表示機能

## 4.1 メッセージカードに画像表示を追加

メッセージカードに画像表示機能を追加します：

```tsx
<Typography
  variant="body1"
  component="p"
  sx={{
    lineHeight: 1.7,
    color: '#1f2937',
    mb: message.image ? 2 : 0,
    fontSize: { xs: '0.95rem', sm: '1rem' },
    fontWeight: 400,
  }}
>
  {message.text}
</Typography>

{message.image && (
  <Box
    sx={{
      display: 'flex',
      justifyContent: 'center',
      width: '100%',
      mt: 2,
    }}
  >
```

---

## 4.2 画像表示の完成

画像表示部分を完成させます：

```tsx
    <Box
      component="img"
      src={message.image}
      alt="Post Image"
      sx={{
        maxWidth: '100%',
        maxHeight: 400,
        objectFit: 'contain',
        borderRadius: 2,
        boxShadow: '0 6px 20px rgba(0,0,0,0.1)',
        transition: 'transform 0.3s ease',
        '&:hover': {
          transform: 'scale(1.02)',
        },
      }}
    />
  </Box>
)}
```

<v-click>

📝 **ポイント：** ホバー時に少し拡大する効果を追加しています．

</v-click>

---

# 5. ファイルサイズ制限とバリデーション

## 5.1 詳細なバリデーション関数

より詳細なファイルバリデーションを実装します：

<div grid="~ cols-2 gap-4">
<div>

```tsx
const validateFile = (file: File): string | null => {
  // ファイルタイプの検証
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
  if (!allowedTypes.includes(file.type)) {
    return 'JPEG、PNG、GIF ファイルのみアップロード可能です';
  }

  // ファイルサイズの検証（5MB以下）
  const maxSize = 5 * 1024 * 1024; // 5MB
  if (file.size > maxSize) {
    return 'ファイルサイズが大きすぎます（5MB以下にしてください）';
  }

  // ファイル名の検証
  if (file.name.length > 100) {
    return 'ファイル名が長すぎます';
  }

  return null;
};
```

</div>
<div>

```tsx
const handleSelectImage = (e) => {
  const file = e.target.files[0];
  if (file) {
    const error = validateFile(file);
    if (error) {
      alert(error);
      e.target.value = ''; // input をクリア
      return;
    }

    setImage(file);
  }
};
```

📝 **バリデーション項目:**
- ファイル形式
- ファイルサイズ
- ファイル名の長さ

</div>
</div>

---

## 5.2 画像の圧縮（オプション）

大きな画像を自動的に圧縮する機能を追加できます：

```tsx
const compressImage = (file, maxWidth = 800, quality = 0.8) => {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = () => {
      const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
      canvas.width = img.width * ratio;
      canvas.height = img.height * ratio;

      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(resolve, 'image/jpeg', quality);
    };

    img.src = URL.createObjectURL(file);
  });
};
```

---

## 5.3 圧縮機能の適用

圧縮機能をファイル選択に適用します：

```tsx
const handleSelectImage = async (e) => {
  const file = e.target.files[0];
  if (file) {
    const error = validateFile(file);
    if (error) {
      alert(error);
      e.target.value = '';
      return;
    }

    // 大きな画像は圧縮
    if (file.size > 1024 * 1024) { // 1MB以上の場合
      const compressedFile = await compressImage(file);
      setImage(compressedFile);
    } else {
      setImage(file);
    }
  }
};
```

---

# 6. UI/UX の改善

## 6.1 ドラッグ&ドロップ機能

ドラッグ&ドロップでファイルを選択できるようにします：

```tsx
const [isDragging, setIsDragging] = useState(false);

const handleDragOver = (e: DragEvent<HTMLDivElement>) => {
  e.preventDefault();
  setIsDragging(true);
};

const handleDragLeave = (e) => {
  e.preventDefault();
  setIsDragging(false);
};

const handleDrop = async (e) => {
  e.preventDefault();
  setIsDragging(false);

  const files = Array.from(e.dataTransfer.files);
  const imageFile = files.find(file => file.type.startsWith('image/'));

  if (imageFile) {
    const error = validateFile(imageFile);
    if (error) {
      alert(error);
      return;
    }
    setImage(imageFile);
  }
};
```

---

## 6.2 ドロップエリアの実装

ドラッグ&ドロップエリアを作成します：

```tsx
<Paper
  elevation={2}
  sx={{
    borderRadius: { xs: 2, sm: 3 },
    p: { xs: 2, sm: 3 },
    mb: { xs: 2, sm: 3 },
    background: colors.surface,
    backdropFilter: 'blur(20px)',
    border: isDragging
      ? '2px dashed #3B82F6'
      : '1px solid rgba(59, 130, 246, 0.1)',
    transition: 'border 0.3s ease',
  }}
  onDragOver={handleDragOver}
  onDragLeave={handleDragLeave}
  onDrop={handleDrop}
>
  <Stack spacing={{ xs: 2, sm: 3 }}>
    {/* 既存の入力フィールドとボタン */}
  </Stack>
</Paper>
```

---

# 7. 動作確認と完成

## 7.1 機能テスト

以下の機能が正しく動作することを確認しましょう：

<v-click>

✅ **テスト項目：**
- 画像ファイルを選択できる
- 画像プレビューが表示される
- 画像付きメッセージを投稿できる
- 投稿された画像が表示される
- ファイルサイズ制限が機能している
- 不正なファイル形式が拒否される

</v-click>

---

## 7.2 完成したコードの確認

画像機能の最終的なコード構造：

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 状態管理
const [image, setImage] = useState<File | null>(null);
const [isDragging, setIsDragging] = useState(false);

// バリデーション
const validateFile = (file: File): string | null => {
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
  if (!allowedTypes.includes(file.type)) {
    return 'JPEG、PNG、GIF ファイルのみアップロード可能です';
  }
  const maxSize = 5 * 1024 * 1024;
  if (file.size > maxSize) {
    return 'ファイルサイズが大きすぎます（5MB以下にしてください）';
  }
  return null;
};

// ファイル選択
const handleSelectImage = (e) => {
  const file = e.target.files[0];
  if (file) {
    const error = validateFile(file);
    if (error) {
      alert(error);
      return;
    }
    setImage(file);
  }
};
```

</div>
<div>

```tsx
// 投稿処理（画像対応）
const handlePost = async (e) => {
  e.preventDefault();
  setIsPosting(true);

  try {
    if (image) {
      const reader = new FileReader();
      reader.onload = () => {
        const newMessage = {
          id: Date.now(),
          text,
          image: reader.result,
          date: new Date().toLocaleString(),
        };
        setMessages((prev) => [newMessage, ...prev]);
      };
      reader.readAsDataURL(image);
    } else {
      // テキストのみの投稿
    }

    setImage(null);
    setText('');
  } finally {
    setIsPosting(false);
  }
};
```

</div>
</div>

---

# 8. 次回の予告

## 8.1 次回の内容

次回は TypeScript で Dexie.js でデータの永続化を実装します：

- TypeScript での Dexie.js の基本設定
- 型安全なデータベーススキーマの定義
- メッセージの保存と読み込み
- 画像データの永続化

<v-click>

## 8.2 今日の宿題 📚

1. 今日実装した TypeScript での画像機能をいろいろ試してみる
2. TypeScript でのブラウザ FileReader API について調べてみる
3. 他のアプリの画像アップロード UI を観察してみる
4. TypeScript の Union Types と Optional Chaining について復習する

</v-click>

---
layout: section
---

# お疲れさまでした！ 🎉

## 次回はデータベース機能を追加します！