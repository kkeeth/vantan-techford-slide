---
theme: default
background: https://picsum.photos/1920/1080
class: text-center
highlighter: shiki
lineNumbers: false
info: |
  ## TypeScript + React ハンズオン講座
  第18回：チャットアプリ開発（データ永続化機能編）
fonts:
  sans: "Josefin Sans"
  serif: "Noto Sans JP"
  mono: "Fira Code"

drawings:
  persist: false
transition: slide-left
title: TypeScript/React 入門講義
---

# TypeScript + React<br>ハンズオン講座

## 第18回：チャットアプリ開発<br>データ永続化機能編

<div class="pt-12">
  <span @click="$slidev.nav.next" class="px-2 py-1 rounded cursor-pointer" hover="bg-white bg-opacity-10">
    Press Space for next page <carbon:arrow-right class="inline"/>
  </span>
</div>

<div class="abs-br m-6 flex gap-2">
  <button @click="$slidev.nav.openInEditor()" title="Open in Editor" class="text-xl slidev-icon-btn opacity-50 !border-none !hover:text-white">
    <carbon:edit />
  </button>
</div>

---
layout: section
---

# 出席確認✋️

---
layout: default
---

# 本日の内容

<Toc minDepth="2" maxDepth="2" />

<style>
h2 {
  margin: 1rem 0;
}
</style>

## 👉️ TypeScript でデータ永続化機能を実装しよう！

---
layout: section
---

# データ永続化機能の実装

---

# 目次

## 1. Dexie.js のインストールとデータベーススキーマ定義
## 2. メッセージの保存・読み込み機能
## 3. アプリ起動時のデータ復元

<style>
h2 {
  margin-bottom: .5rem;
}
</style>

---

# 1. Dexie.js のインストールとデータベーススキーマ定義

## 1.1 ページリロードでデータが消えてしまう問題

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 現在の状況：ページリロードでメッセージが消える
const App = () => {
  const [messages, setMessages] = useState<Message[]>([]);

  // ページリロード時に messages は空配列に戻る
  // → ユーザーが投稿したメッセージが全て消失

  // データ永続化が必要！
};
```

</div>
<div>

**現在の問題点**
- ページリロードでメッセージが全て消える
- ブラウザを閉じるとデータが失われる
- 実用的なアプリにするためには永続化が必要

**解決策：Dexie.js**
- ブラウザの IndexedDB を簡単に使えるライブラリ
- TypeScript 完全対応
- オフラインでも動作

</div>
</div>

---

## 1.2 Dexie.js が必要になったのでインストール

<div grid="~ cols-2 gap-4">
<div>

```bash
# データ永続化ライブラリをインストール
npm install dexie

# TypeScript の型定義も一緒にインストールされる
```

</div>
<div>

**Dexie.js の特徴**
- IndexedDB のラッパーライブラリ
- 複雑な IndexedDB API を簡単に使用可能
- TypeScript でのスキーマ定義が可能
- Promise ベースの API
- React との相性が良い

</div>
</div>

---

## 1.3 App.tsx 内でデータベース設定

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
- import { useState, useCallback, type ChangeEvent, type FormEvent } from 'react';
+ import { useEffect, useState, useCallback, type ChangeEvent, type FormEvent } from 'react';
+ import Dexie from 'dexie';
  import './App.css';
  import {
    // Material-UI のインポート...
  } from '@mui/material';
  import { Colors, Message } from './types';

  // データベースの設定
+ const db = new Dexie('ChatApp');
+ db.version(1).stores({
+   messages: 'id, createdAt',
+ });

+ const MAX_MESSAGE_LENGTH = 140;

  const App = () => {
    // 状態管理...
  };
```

</div>
<div>

**データベース設定のポイント**
- `db.ts` は作成せず，App.tsx 内で直接設定
- `new Dexie('ChatApp')` でデータベース作成
- `version(1).stores()` でスキーマ定義
- `createdAt` フィールドを追加

</div>
</div>

---

# 2. メッセージの保存・読み込み・削除機能

## 2.1 投稿処理をデータベース対応に更新

<div grid="~ cols-2 gap-4">
<div>

```diff
      const newMessage: Message = {
        id: uuidv4(),
        text: text.trim(),
        image: imageData,
        imageName: image?.name,
        date: dateString,
        createdAt,
      };
      // データベースに保存
+     await db.messages.add(newMessage);
      setMessages((prev) => [newMessage, ...prev]);
      setImage(null);
      setText('');
    } catch (error) {
```
</div>
<div>

**型定義の更新ポイント**
- `uuidv4()` で一意な ID を生成は継続
- 今後 Dexie での保存機能を追加予定

</div>
</div>

---

## 2.2 削除処理をデータベース対応に更新

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 削除処理をデータベース対応に更新
const deleteMessage = useCallback(
  async (id: string): Promise<void> => {
    const message = messages.find((m) => m.id === id);
    if (!message) return;

    const previewText =
      message.text.length > 20
        ? message.text.substring(0, 20) + '...'
        : message.text;

    if (window.confirm(`「${previewText}」を削除しますか？`)) {
      try {
        await db.messages.delete(id);
        setMessages((prev) => prev.filter((message) => message.id !== id));
      } catch (error) {
        console.error('削除に失敗しました:', error);
        alert('削除に失敗しました');
      }
    }
  },
  [messages],
);
```

</div>
<div>

```diff
  <Button
    size="small"
    color="error"
+   startIcon={<DeleteIcon />}
+   onClick={() => handleDeleteMessage(message.id)}
    sx={{
      borderRadius: 2,
      fontSize: { xs: '0.8rem', sm: '0.875rem' },
      '&:hover': {
        backgroundColor: 'rgba(244, 67, 54, 0.08)',
      },
    }}
  >
    削除
  </Button>
```

**削除処理のポイント**
- `useCallback` でメモ化
- メモリ上の state から削除
- エラーハンドリングで安全性を確保

</div>
</div>

---

# 3. アプリ起動時のデータ復元

<div grid="~ cols-2 gap-4">
<div>

```diff
const App = () => {
  const [text, setText] = useState<string>('');
  const [messages, setMessages] = useState<Message[]>([]);
  const [isPosting, setIsPosting] = useState<boolean>(false);
  const [image, setImage] = useState<File | null>(null);
+ const [isLoading, setIsLoading] = useState<boolean>(true);

+ // メッセージ読み込み
+ useEffect(() => {
+   const loadMessages = async (): Promise<void> => {
+     try {
+       const allMessages = await db.messages
+         .orderBy('createdAt')
+         .reverse()
+         .toArray();
+       setMessages(allMessages);
+     } catch (error) {
+       console.error('メッセージの読み込みに失敗しました:', error);
+     } finally {
+       setIsLoading(false);
+     }
+   };
+   loadMessages();
+ }, []);
```

</div>
<div>

```diff
  // 読み込み中の表示
+ if (isLoading) {
+   return (
+     <Box
+       sx={{
+         minHeight: '100vh',
+         display: 'flex',
+         alignItems: 'center',
+         justifyContent: 'center',
+         background: colors.background,
+       }}
+     >
+       <Typography variant="h6">読み込み中...</Typography>
+     </Box>
+   );
+ }

  return (
    // 既存の JSX
  );
};
```

</div>
</div>

<div grid="~ cols-2 gap-4">
<div>

**初期化処理のポイント**
- `useEffect` でアプリ起動時にデータ読み込み
- `db.messages.toArray()` で全メッセージを取得
- `.reverse()` で新しい順に並べ替え
- `isLoading` 状態で読み込み中を表示
- 空の依存配列で初回のみ実行

</div>
</div>

---

# 4. 次回の予告

次回は TypeScript でアプリの仕上げと機能拡張を行います：

- 設定画面の追加（ダークモード等）
- エクスポート・インポート機能
- パフォーマンス最適化
- TypeScript での React.memo 活用
- プロダクション向けの最終調整

---
layout: section
---

# お疲れさまでした！ 🎉

## 次回はアプリの仕上げを行います！