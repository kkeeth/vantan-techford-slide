---
theme: default
background: https://picsum.photos/1920/1080
class: text-center
highlighter: shiki
lineNumbers: false
info: |
  ## TypeScript + React ハンズオン講座
  第17回：チャットアプリ開発（画像アップロード機能編）
fonts:
  sans: "Josefin Sans"
  serif: "Noto Sans JP"
  mono: "Fira Code"

drawings:
  persist: false
transition: slide-left
title: TypeScript/React 入門講義
---

# TypeScript + React<br>ハンズオン講座

## 第17回：チャットアプリ開発<br>画像アップロード機能編

<div class="pt-12">
  <span @click="$slidev.nav.next" class="px-2 py-1 rounded cursor-pointer" hover="bg-white bg-opacity-10">
    Press Space for next page <carbon:arrow-right class="inline"/>
  </span>
</div>

<div class="abs-br m-6 flex gap-2">
  <button @click="$slidev.nav.openInEditor()" title="Open in Editor" class="text-xl slidev-icon-btn opacity-50 !border-none !hover:text-white">
    <carbon:edit />
  </button>
</div>

<style>
  h1 {
    color: #fff;
  }
</style>

---
layout: section
---

# 出席確認✋️

---
layout: default
---

# 本日の内容

<Toc minDepth="2" maxDepth="2" />

<style>
h2 {
  margin: 1rem 0;
}
</style>

## 👉️ TypeScript で画像アップロード機能を実装しよう！

---
layout: section
---

# 画像アップロード機能の実装

---

# 目次

## 1. 画像状態管理と File API の基本
## 2. 画像選択とプレビュー機能
## 3. 画像付きメッセージの投稿
## 4. 画像表示機能の実装

※ 画像機能が必要になった段階で型定義を拡張していく自然な開発フローで進めます．

<style>
h2 {
  margin-bottom: .5rem;
}
</style>

---

# 1. Message 型の拡張と画像状態管理

## 1.1 Message 型に image プロパティを追加

<div grid="~ cols-2 gap-4">
<div>

```tsx
// src/types.ts
export type Message = {
  id: number;
  text: string;
  date: string;
  image?: string; // 画像データ（Base64）をオプショナルプロパティとして追加
};
```

</div>
<div>

**型の拡張ポイント**
- 画像機能が必要になった時点で `image?` を追加
- `?` でオプショナルプロパティにすることで既存コードを破壊しない
- `string` 型で Base64 データ URL を想定
- 実際の開発では必要に応じて型を拡張

</div>
</div>

---

## 1.2 画像状態管理の追加

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
const App = () => {
  const [text, setText] = useState<string>('');
  const [messages, setMessages] = useState<Message[]>([]);
  const [isPosting, setIsPosting] = useState<boolean>(false);
  const theme = useTheme();
  const colors: Colors = {
    // 中略
  };

  // 画像ファイルを管理する状態を追加
+ const [image, setImage] = useState<File | null>(null);

  // 既存の処理...
};
```

</div>
<div>

**画像状態管理のポイント**
- `File | null` で TypeScript の Union Types を活用
- `File` はブラウザ標準の File API の型
- `null` は画像が選択されていない状態を表現
- 画像が必要になった時点で状態を追加

</div>
</div>

---

# 2. 画像選択とバリデーション

## 2.1 画像選択ボタンの機能追加

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
- import { Send as SendIcon, Delete as DeleteIcon } from '@mui/icons-material';
+ import {
+   Send as SendIcon,
+   Delete as DeleteIcon,
+   Image as ImageIcon,
+ } from '@mui/icons-material';

// 中略

  const App = () => {
    // 中略

+   const handleSelectImage = useCallback(
+     (e: ChangeEvent<HTMLInputElement>): void => {
+       const file = e.target.files?.[0];
+       if (file) {
+         setImage(file);
+       }
+     }, []);

    return (
```

</div>
<div>

```diff
  <TextField
    // 中略
  />
+ <Button
+   variant="outlined"
+   component="label"
+   startIcon={<ImageIcon />}
+   sx={{
+     flex: 1,
+     width: { xs: '100%', sm: 'auto' },
+     height: 48,
+     borderRadius: 2,
+   }}
+ >
+   画像を追加
+   <input
+     type="file"
+     hidden
+     accept="image/png, image/jpg, image/jpeg, image/gif"
+     onChange={handleSelectImage}
+   />
+ </Button>
  <Fab>
```

</div>
</div>

---

## 2.2 ファイルバリデーション機能の追加

<div grid="~ cols-2 gap-4">
<div>

```tsx
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
const MAX_FILENAME_LENGTH = 100;

//（中略）

// ファイルの安全性チェック関数を追加
const validateFile = (file: File): string => {
  // ファイルタイプの検証
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
  if (!allowedTypes.includes(file.type)) {
    return 'JPEG，PNG，GIF ファイルのみアップロード可能です';
  }

  // ファイルサイズの検証（5MB以下）
  if (file.size > MAX_FILE_SIZE) {
    return `ファイルサイズが大きすぎます（${MAX_FILE_SIZE} MB 以下にしてください）`;
  }

  // ファイル名の長さチェック
  if (file.name.length > MAX_FILENAME_LENGTH) {
    return `ファイル名が長すぎます（${MAX_FILENAME_LENGTH} 文字以内にしてください）`;
  }

  return '';
};
```

</div>
<div>

```diff
  const handleSelectImage = useCallback(
    (e: ChangeEvent<HTMLInputElement>): void => {
      const file = e.target.files?.[0];
      if (file) {
+       const error = validateFile(file);
+       if (error) {
+         alert(error);
+         e.target.value = ''; // input をクリア
+         return;
+       }
        setImage(file);
      }
    },
    [],
  );
```

**バリデーション実装**
- `File` 型のプロパティを型安全に使用
- `file.type` で MIME タイプをチェック
- `file.size` でファイルサイズをチェック
- ファイル名の長さもチェック
- エラー時は input をクリアして再選択可能に

</div>
</div>

---

## 2.3 画像選択，投稿ボタンのスタイル調整

```diff
+   <Box
+     sx={{
+       display: 'flex',
+       gap: 2,
+       alignItems: 'center',
+       flexDirection: { xs: 'column', sm: 'row' },
+     }}
+   >
      <Button>
        （中略）
      </Button>
      <Fab>
        （中略）
      </Fab>
+   </Box>
  </Stack>
```

---

# 3. 画像プレビュー機能

## 3.1 画像プレビューの実装

<div grid="~ cols-2 gap-4">
<div>

```tsx
// <TextField /> の下に記述
{image && (
  <Paper
    elevation={2}
    sx={{
      p: 2,
      borderRadius: 2,
      background: 'rgba(255, 255, 255, 0.8)',
      border: '1px solid rgba(59, 130, 246, 0.1)',
    }}
  >
    <Typography
      variant="body2"
      color="text.secondary"
      sx={{ mb: 1 }}
    >
      📸 画像プレビュー
    </Typography>
```


</div>
<div>

```tsx
    <Box
      sx={{
        display: 'flex',
        justifyContent: 'center',
        width: '100%',
      }}
    >
      <Box
        component="img"
        alt="Preview"
        src={URL.createObjectURL(image)}
        sx={{
          maxWidth: '80%',
          maxHeight: 200,
          objectFit: 'contain',
          borderRadius: 2,
          boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
        }}
      />
    </Box>
  </Paper>
```

</div>
</div>

---

## 3.2 プレビュー操作機能の追加

<div grid="~ cols-2 gap-4">
<div>

```tsx
    {/* 画像プレビューの Box コンポーネントの下 */}
    <Box
      sx={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        mt: 2,
      }}
    >
      <Typography variant="caption" color="text.secondary">
        {image.name} ({Math.round(image.size / 1024)}KB)
      </Typography>
      <Button
        size="small"
        color="error"
        startIcon={<DeleteIcon />}
        sx={{
          borderRadius: 2,
          fontSize: { xs: '0.8rem', sm: '0.875rem' },
          '&:hover': {
            backgroundColor: 'rgba(244, 67, 54, 0.08)',
          }
        }}
      >
        削除
      </Button>
    </Box>
```

</div>
<div>

**ファイル情報表示**
- `image.name` でファイル名を表示
- `image.size / 1024` でKB単位でサイズ表示
- 削除ボタンで `setImage(null)` でプレビューをクリア
- TypeScript が `image` のプロパティ存在を保証

</div>
</div>

---

# 4. 画像付きメッセージの投稿

## 4.1 画像対応の投稿処理に更新

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/types.ts
  export type Message = {
    id: string;
    text: string;
    date: string;
+   image?: string;
+   imageName?: string;
+   createdAt?: Date;
  }
```

```tsx
// src/App.tsx
// 画像を Base64 に変換
const readImageAsDataURL = (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result as string);
    reader.onerror = () => reject(reader.error);
    reader.readAsDataURL(file);
  });
};
```

</div>
<div>

**FileReader API の使い方**
- `FileReader` は File オブジェクトを読み込むブラウザ標準 API
- `readAsDataURL()` でファイルを Base64 エンコードされたデータ URL に変換
- `onload` イベントで読み込み完了時の処理を定義
- `onerror` イベントでエラー時の処理を定義
- `reader.result` に変換結果（Base64 文字列）が格納される
- `Promise` でラップすることで async/await で使える形に
- データ URL 形式： `data:image/png;base64,..`

</div>
</div>

---

## 4.2 handlePost 関数の更新

<div grid="~ cols-2 gap-4">
<div>

```diff
（続き）
  const handlePost = useCallback(
-   (e: FormEvent<HTMLFormElement>): void => {
+   async (e: FormEvent<HTMLFormElement>): Promise<void> => {
      e.preventDefault();

      // 中略

      try {
+       const createdAt = new Date();
+       const dateString = createdAt.toLocaleString();
+       const imageData = image ? await readImageAsDataURL(image) : undefined;
```

</div>
<div>

```diff
+         const newMessage: Message = {
+           id: uuidv4(),
+           text: text.trim(),
+           image: imageData,
+           imageName: image?.name,
+           date: dateString,
+           createdAt,
+         };
          setMessages((prev) => [newMessage, ...prev]);
+         setImage(null);
          setText('');
        } catch (error) {
          // 中略
        },
-       [text],
+       [text, image],
      );
```

</div>
</div>

---

# 5. 画像表示機能の実装

## 5.1 メッセージカードに画像表示を追加

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
  <CardContent sx={{ p: { xs: 2, sm: 3 } }}>
    {/* 日時表示 */}
    <Box sx={{ mb: 2 }}>
      // 中略
    </Box>

    {/* テキスト表示 */}
    <Typography
      variant="body1"
      component="p"
      sx={{
        lineHeight: 1.7,
        color: '#1f2937',
+       mb: message.image ? 2 : 0, // 画像があれば下マージン追加
        fontSize: { xs: '0.95rem', sm: '1rem' },
      }}
    >
      {message.text}
    </Typography>
```

</div>
<div>

```diff
+   {/* 画像表示 */}
+   {message.image && (
+     <Box sx={{ display: 'flex', justifyContent: 'center', mt: 2 }}>
+       <Box
+         component="img"
+         src={message.image}
+         alt={message.imageName}
+         sx={{
+           maxWidth: '100%',
+           maxHeight: 400,
+           objectFit: 'contain',
+           borderRadius: 2,
+           boxShadow: '0 6px 20px rgba(0,0,0,0.1)',
+         }}
+       />
+     </Box>
+   )}
  </CardContent>
```

</div>
</div>

---

## 5.2 画像のユーザビリティ向上

<div grid="~ cols-2 gap-4">
<div>

```diff
          objectFit: 'contain',
          borderRadius: 2,
          boxShadow: '0 6px 20px rgba(0,0,0,0.1)',
+         transition: 'transform 0.3s ease',
+         '&:hover': {
+           transform: 'scale(1.02)',
+         },
        }}
      />
    </Box>
  )}
```

</div>
<div>

**UX 向上のポイント**
- ホバー時に slight scale で視覚的フィードバック
- `objectFit: 'contain'` で画像の縦横比を維持
- `transition` でスムーズなアニメーション
- レスポンシブ対応で画像サイズを制限

</div>
</div>

---

# 6. 次回の予告

### 次回は TypeScript でデータ永続化機能を実装します：

- Dexie.js のインストールと App.tsx 内での設定
- `types.ts` の Message 型に `createdAt?: Date` を追加
- `types.ts` に `MessageWithoutId` 型を追加
- メッセージと画像の永続化
- オフライン対応の実装

---
layout: section
---

# お疲れさまでした！ 🎉

## 次回はデータ永続化機能を作ります！