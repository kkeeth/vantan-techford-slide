---
theme: default
background: https://picsum.photos/1920/1080
class: text-center
highlighter: shiki
lineNumbers: true
info: |
  ## TypeScript + React ハンズオン講座
  第17回：チャットアプリ開発（画像アップロード機能編）
fonts:
  sans: "Josefin Sans"
  serif: "Noto Sans JP"
  mono: "Fira Code"

drawings:
  persist: false
transition: slide-left
title: TypeScript/React 入門講義
---

# TypeScript + React<br>ハンズオン講座

## 第17回：チャットアプリ開発<br>画像アップロード機能編

<div class="pt-12">
  <span @click="$slidev.nav.next" class="px-2 py-1 rounded cursor-pointer" hover="bg-white bg-opacity-10">
    Press Space for next page <carbon:arrow-right class="inline"/>
  </span>
</div>

<div class="abs-br m-6 flex gap-2">
  <button @click="$slidev.nav.openInEditor()" title="Open in Editor" class="text-xl slidev-icon-btn opacity-50 !border-none !hover:text-white">
    <carbon:edit />
  </button>
</div>

<style>
h1 {
  background-color: #fff;
  background-image: none;
}
</style>

---
layout: section
---

# 出席確認✋️

---
layout: default
---

# 本日の内容

<Toc minDepth="2" maxDepth="2" />

<style>
h2 {
  margin: 1rem 0;
}
</style>

## 👉️ TypeScript で画像アップロード機能を実装しよう！

---
layout: section
---

# 画像アップロード機能の実装

---

# 目次

## 1. 画像状態管理と File API の基本
## 2. 画像選択とプレビュー機能
## 3. 画像付きメッセージの投稿
## 4. 画像表示機能の実装

※ 画像機能が必要になった段階で型定義を拡張していく自然な開発フローで進めます．

<style>
h2 {
  margin-bottom: .5rem;
}
</style>

---

# 1. 画像状態管理と File API の基本

## 1.1 画像アップロード機能が必要になったので状態を追加

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 画像アップロード機能が欲しくなったので状態を追加
const App = () => {
  const [text, setText] = useState<string>('');
  const [messages, setMessages] = useState<Message[]>([]);
  const [isPosting, setIsPosting] = useState<boolean>(false);

  // 画像ファイルを管理する状態を追加
  const [image, setImage] = useState<File | null>(null);

  // 既存の処理...
};
```

</div>
<div>

**画像状態管理のポイント**
- `File | null` で TypeScript の Union Types を活用
- `File` は ブラウザ標準の File API の型
- `null` は画像が選択されていない状態を表現
- 実際の開発では機能が必要になった時点で状態を追加

</div>
</div>

---

## 1.2 画像選択ボタンの機能追加

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 画像選択機能が必要になったので実装
const handleSelectImage = (e: ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (file) {
    console.log('選択されたファイル:', file);
    setImage(file);
  }
};

// 既存の画像ボタンに機能を追加
<Button
  variant="outlined"
  component="label"
  startIcon={<ImageIcon />}
  sx={{
    flex: 1,
    height: 48,
    borderColor: colors.primary,
    color: colors.primary,
  }}
>
  画像を追加
  <input
    type="file"
    hidden
    accept="image/*"
    onChange={handleSelectImage}
  />
</Button>
```

</div>
<div>

**File API の基本**
- `e.target.files?.[0]` で Optional Chaining 使用
- `accept="image/*"` で画像ファイルのみ選択可能
- `component="label"` で Button を label として使用
- `hidden` で実際の input は非表示

</div>
</div>

---

## 1.3 ファイル バリデーション機能が必要になったので追加

<div grid="~ cols-2 gap-4">
<div>

```tsx
// ファイルの安全性チェックが必要になったので関数を追加
const validateFile = (file: File): string | null => {
  // ファイルタイプの検証
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
  if (!allowedTypes.includes(file.type)) {
    return 'JPEG、PNG、GIF ファイルのみアップロード可能です';
  }

  // ファイルサイズの検証（5MB以下）
  const maxSize = 5 * 1024 * 1024; // 5MB
  if (file.size > maxSize) {
    return 'ファイルサイズが大きすぎます（5MB以下にしてください）';
  }

  return null;
};

const handleSelectImage = (e: ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (file) {
    const error = validateFile(file);
    if (error) {
      alert(error);
      e.target.value = ''; // input をクリア
      return;
    }
    setImage(file);
  }
};
```

</div>
<div>

**バリデーション実装**
- `File` 型のプロパティを型安全に使用
- `file.type` でMIMEタイプをチェック
- `file.size` でファイルサイズをチェック
- エラー時は input をクリアして再選択可能に

</div>
</div>

---

# 2. 画像選択とプレビュー機能

## 2.1 画像プレビューが欲しくなったので実装

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 投稿フォームの下に画像プレビューを追加
{image && (
  <Paper
    elevation={2}
    sx={{
      p: 2,
      borderRadius: 2,
      background: 'rgba(255, 255, 255, 0.8)',
      border: '1px solid rgba(59, 130, 246, 0.1)',
    }}
  >
    <Typography
      variant="body2"
      color="text.secondary"
      sx={{ mb: 1 }}
    >
      📸 画像プレビュー
    </Typography>
    <Box
      sx={{
        display: 'flex',
        justifyContent: 'center',
        width: '100%',
      }}
    >
      <Box
        component="img"
        alt="Preview"
        src={URL.createObjectURL(image)}
        sx={{
          maxWidth: '80%',
          maxHeight: 200,
          objectFit: 'contain',
          borderRadius: 2,
          boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
        }}
      />
    </Box>
```

</div>
<div>

**画像プレビュー実装**
- `URL.createObjectURL(image)` でファイルをURLに変換
- `image &&` で条件付きレンダリング
- `objectFit: 'contain'` で画像の縦横比を維持
- TypeScript が `image` の存在を保証

</div>
</div>

---

## 2.2 プレビュー操作機能の追加

<div grid="~ cols-2 gap-4">
<div>

```tsx
    {/* プレビューの下にファイル情報と削除ボタン */}
    <Box
      sx={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        mt: 2,
      }}
    >
      <Typography variant="caption" color="text.secondary">
        {image.name} ({Math.round(image.size / 1024)}KB)
      </Typography>
      <Button
        size="small"
        color="error"
        onClick={() => setImage(null)}
        sx={{
          minWidth: 'auto',
          px: 1,
        }}
      >
        削除
      </Button>
    </Box>
  </Paper>
)}
```

</div>
<div>

**ファイル情報表示**
- `image.name` でファイル名を表示
- `image.size / 1024` でKB単位でサイズ表示
- 削除ボタンで `setImage(null)` でプレビューをクリア
- TypeScript が `image` のプロパティ存在を保証

</div>
</div>

---

# 3. 画像付きメッセージの投稿

## 3.1 画像機能に対応するため Message 型を拡張

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 画像機能が必要になったので Message 型を拡張
// src/types.ts
export type Message = {
  id: number;
  text: string;
  date: string;
  image?: string; // オプショナルプロパティとして追加
};
```

</div>
<div>

**型の段階的拡張**
- 画像機能が必要になった時点で `image?` を追加
- `?` でオプショナルプロパティにすることで既存コードを破壊しない
- `string` 型でBase64データURLを想定
- 実際の開発では必要に応じて型を拡張

</div>
</div>

---

## 3.2 画像対応の投稿処理に更新

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 画像対応のため投稿処理を更新
const handlePost = async (e: FormEvent) => {
  e.preventDefault();

  const error = validateMessage(text);
  if (error) {
    alert(error);
    return;
  }

  setIsPosting(true);

  try {
    const newMessage: Message = {
      id: Date.now(),
      text: text.trim(),
      date: new Date().toLocaleString(),
    };

    // 画像がある場合の処理
    if (image) {
      const reader = new FileReader();
      reader.onload = () => {
        const messageWithImage: Message = {
          ...newMessage,
          image: reader.result as string,
        };
        setMessages(prev => [messageWithImage, ...prev]);
      };
      reader.readAsDataURL(image);
    } else {
      setMessages(prev => [newMessage, ...prev]);
    }

    // 入力内容をクリア
    setText('');
    setImage(null);
  } finally {
    setIsPosting(false);
  }
};
```

</div>
<div>

**FileReader API の活用**
- `FileReader` でファイルをBase64文字列に変換
- `readAsDataURL()` は非同期処理
- `reader.onload` でコールバック処理
- `reader.result as string` で型アサーション

</div>
</div>

---

# 4. 画像表示機能の実装

## 4.1 メッセージカードに画像表示を追加

<div grid="~ cols-2 gap-4">
<div>

```tsx
// メッセージカード内に画像表示を追加
<CardContent sx={{ p: { xs: 2, sm: 3 } }}>
  {/* 日時表示 */}
  <Box sx={{ mb: 2 }}>
    <Chip
      label={formatRelativeTime(message.date)}
      size="small"
      variant="outlined"
      sx={{
        height: 24,
        fontSize: '0.75rem',
        borderColor: colors.primary,
        color: colors.primary,
      }}
    />
  </Box>

  {/* テキスト表示 */}
  <Typography
    variant="body1"
    component="p"
    sx={{
      lineHeight: 1.7,
      color: '#1f2937',
      mb: message.image ? 2 : 0, // 画像があれば下マージン追加
      fontSize: { xs: '0.95rem', sm: '1rem' },
    }}
  >
    {message.text}
  </Typography>

  {/* 画像表示 */}
  {message.image && (
    <Box sx={{ display: 'flex', justifyContent: 'center', mt: 2 }}>
      <Box
        component="img"
        src={message.image}
        alt="投稿画像"
        sx={{
          maxWidth: '100%',
          maxHeight: 400,
          objectFit: 'contain',
          borderRadius: 2,
          boxShadow: '0 6px 20px rgba(0,0,0,0.1)',
        }}
      />
    </Box>
  )}
</CardContent>
```

</div>
<div>

**画像表示の実装**
- `message.image &&` で条件付き表示
- `message.image` がある場合のみ画像を表示
- `mb: message.image ? 2 : 0` で動的マージン調整
- レスポンシブ対応で画像サイズを制限

</div>
</div>

---

## 4.2 画像のユーザビリティ向上

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 画像にホバー効果とクリック機能を追加
{message.image && (
  <Box sx={{ display: 'flex', justifyContent: 'center', mt: 2 }}>
    <Box
      component="img"
      src={message.image}
      alt="投稿画像"
      sx={{
        maxWidth: '100%',
        maxHeight: 400,
        objectFit: 'contain',
        borderRadius: 2,
        boxShadow: '0 6px 20px rgba(0,0,0,0.1)',
        transition: 'transform 0.3s ease',
        cursor: 'pointer',
        '&:hover': {
          transform: 'scale(1.02)',
        },
      }}
      onClick={() => {
        // 画像を新しいタブで開く
        window.open(message.image, '_blank');
      }}
    />
  </Box>
)}
```

</div>
<div>

**UX 向上のポイント**
- ホバー時に slight scale で視覚的フィードバック
- `cursor: 'pointer'` でクリック可能であることを示す
- クリックで新しいタブで画像を開く
- `transition` でスムーズなアニメーション

</div>
</div>

---

# 5. エラーハンドリングと最適化

## 5.1 画像処理のエラーハンドリング強化

<div grid="~ cols-2 gap-4">
<div>

```tsx
// より詳細なエラーハンドリングを追加
const handleSelectImage = (e: ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];

  if (!file) return;

  try {
    const error = validateFile(file);
    if (error) {
      alert(error);
      e.target.value = '';
      return;
    }

    // ファイル読み込みエラーのハンドリング
    const reader = new FileReader();
    reader.onerror = () => {
      alert('ファイルの読み込みに失敗しました');
      setImage(null);
    };

    reader.onload = () => {
      setImage(file);
    };

    // プレビュー用にファイルを読み込み
    reader.readAsDataURL(file);

  } catch (error) {
    console.error('ファイル処理エラー:', error);
    alert('ファイル処理中にエラーが発生しました');
    setImage(null);
  }
};
```

</div>
<div>

**エラーハンドリング強化**
- `try/catch` で例外処理
- `reader.onerror` でファイル読み込みエラーを捕捉
- エラー時は適切にstateをリセット
- ユーザーにわかりやすいエラーメッセージ

</div>
</div>

---

## 5.2 画像機能の完成とテスト

<div grid="~ cols-2 gap-4">
<div>

```tsx
// 最終的な画像機能の状態
const App = () => {
  const [text, setText] = useState<string>('');
  const [messages, setMessages] = useState<Message[]>([]);
  const [isPosting, setIsPosting] = useState<boolean>(false);
  const [image, setImage] = useState<File | null>(null);

  const validateFile = (file: File): string | null => {
    // バリデーション実装済み
  };

  const handleSelectImage = (e: ChangeEvent<HTMLInputElement>) => {
    // 画像選択処理実装済み
  };

  const handlePost = async (e: FormEvent) => {
    // 画像対応投稿処理実装済み
  };

  return (
    // JSX実装済み
  );
};
```

</div>
<div>

**機能テストチェックリスト**

✅ 画像ファイル選択機能
✅ 画像プレビュー表示
✅ ファイルバリデーション
✅ 画像付きメッセージ投稿
✅ 投稿画像の表示
✅ エラーハンドリング
✅ ユーザビリティ向上
✅ TypeScript型安全性

**TypeScript 活用ポイント**
- `File | null` で Union Types
- Optional Chaining `?.`
- 型アサーション `as string`
- オプショナルプロパティ `image?`

</div>
</div>

---

# 6. 次回の予告

## 6.1 次回の内容（第18回）

次回は TypeScript でデータ永続化機能を実装します：

- Dexie.js のインストールと設定
- TypeScript でのデータベーススキーマ定義
- メッセージと画像の永続化
- オフライン対応の実装
- 必要になった時点でライブラリを追加する流れ

<v-click>

## 6.2 今日の宿題 📚

1. 今日実装した画像アップロード機能をいろいろ試してみる
2. File API と FileReader API について調べてみる
3. 他のアプリの画像アップロード UI を観察してみる
4. TypeScript の Union Types と Optional Chaining を復習する

</v-click>

---
layout: section
---

# お疲れさまでした！ 🎉

## 次回はデータ永続化機能を作ります！