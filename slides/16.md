---
theme: default
background: https://picsum.photos/1920/1080
class: text-center
highlighter: shiki
lineNumbers: false
info: |
  ## TypeScript + React ハンズオン講座
  第16回：チャットアプリ開発（メッセージ機能編）
fonts:
  sans: "Josefin Sans"
  serif: "Noto Sans JP"
  mono: "Fira Code"

drawings:
  persist: false
transition: slide-left
title: TypeScript/React 入門講義
---

# TypeScript + React<br>ハンズオン講座

## 第16回：チャットアプリ開発<br>メッセージ機能編

<div class="pt-12">
  <span @click="$slidev.nav.next" class="px-2 py-1 rounded cursor-pointer" hover="bg-white bg-opacity-10">
    Press Space for next page <carbon:arrow-right class="inline"/>
  </span>
</div>

<div class="abs-br m-6 flex gap-2">
  <button @click="$slidev.nav.openInEditor()" title="Open in Editor" class="text-xl slidev-icon-btn opacity-50 !border-none !hover:text-white">
    <carbon:edit />
  </button>
</div>

---
layout: section
---

# 出席確認✋️

---
layout: default
---

# 本日の内容

<Toc minDepth="2" maxDepth="2" />

<style>
h2 {
  margin: 1rem 0;
}
</style>

## 👉️ TypeScript でメッセージ投稿・表示機能を実装しよう！

---
layout: section
---

# メッセージ機能の実装

---

# 目次

## 1. メッセージ投稿機能の実装
## 2. メッセージリスト表示機能の実装
## 3. 削除機能とユーザビリティ向上

※ 今回は機能を作りながら必要な型定義を追加していく実践的な流れで進めます．

<style>
h2 {
  margin-bottom: .5rem;
}
</style>

---

# 1. 型定義ファイルの作成

## 1.1 Message 型の定義

<div grid="~ cols-2 gap-4">
<div>

```tsx
// src/types.ts
export type Message = {
  id: string;
  text: string;
  date: string;
};
```

</div>
<div>

**型定義のポイント**
- メッセージの基本型を定義
- `id`: メッセージの一意識別子（文字列）
- `text`: メッセージ本文（文字列）
- `date`: 投稿日時（文字列）
- 画像機能は後で追加するため，ここでは含めない

</div>
</div>

---

# 2. メッセージ投稿機能の実装

## 2.1 メッセージ入力 UI の基本構造

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
  import {
    Container,
    Typography,
    Box,
    Paper,
+   TextField,
+   Stack,
+   Fab,
    useTheme,
  } from '@mui/material';
+ import { Send as SendIcon } from '@mui/icons-material';
  import type { Colors } from './types';
  import './App.css';

  const App = () => {
    const theme = useTheme();
    const colors: Colors = {
      primary: theme.palette.primary.main,
      surface: theme.palette.background.paper,
      gradient: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,
    };
```

</div>
<div>

```diff
// src/App.tsx
      <Box sx={{ minHeight: '100vh' }}>
        <Container maxWidth="md">
          {/* ヘッダー省略 */}

+         {/* 入力フォーム */}
+         <Paper elevation={2}>
+           <form>
+             <Stack spacing={2}>
+               <TextField
+                 label="今の気分はいかがでしょうか？"
+                 multiline
+                 fullWidth
+                 rows={4}
+                 variant="outlined"
+               />
+               <Fab
+                 color="primary"
+                 type="submit"
+                 size="large"
```

</div>
</div>

---

## 2.1 メッセージ入力 UI の基本構造

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
+               >
+                 <SendIcon />
+               </Fab>
+             </Stack>
+           </form>
+         </Paper>
        </Container>
      </Box>
    );
  };
```

</div>
<div>

**UI 構成のポイント**
- `TextField`: Material-UI の標準入力コンポーネント
- `multiline`, `rows={4}`: 複数行入力に対応
- `variant="outlined"`: アウトライン形式
- `Stack`: 縦方向のレイアウト
- `Fab`: フローティングアクションボタン（アイコンのみ）

</div>
</div>

---

## 2.2 入力フォームのスタイリング

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
  const App = () => {
    const theme = useTheme();
    const colors: Colors = {
+     primary: theme.palette.primary.main,
+     surface: theme.palette.background.paper,
      gradient: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,
    };

    return (
```

```diff
// src/main.tsx
    secondary: {
      main: '#10B981',
-   }
+   },
+   background: {
+     default: 'linear-gradient(135deg, #F0F9FF 0%, #ECFDF5 100%)',
+     paper: 'rgba(255, 255, 255, 0.95)',
+   },
+ }
```

</div>
<div>

```diff
// src/App.tsx
          {/* 入力フォーム */}
-         <Paper elevation={2}>
+         <Paper
+           elevation={2}
+           sx={{
+             borderRadius: { xs: 2, sm: 3 },
+             p: { xs: 2, sm: 3 },
+             mb: { xs: 2, sm: 3 },
+             background: colors.surface,
+             backdropFilter: 'blur(20px)',
+             border: '1px solid rgba(59, 130, 246, 0.1)',
+           }}
+         >
            <form>
-             <Stack spacing={2}>
+             <Stack spacing={{ xs: 2, sm: 3 }}>
```

</div>
</div>

---

## 2.2 入力フォームのスタイリング

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
                <TextField
                  label="今の気分はいかがでしょうか？"
                  multiline
                  fullWidth
                  rows={4}
                  variant="outlined"
+                 sx={{
+                   '& .MuiOutlinedInput-root': {
+                     borderRadius: 2,
+                     backgroundColor: 'rgba(255, 255, 255, 0.8)',
+                     '&:hover fieldset': {
+                       borderColor: colors.primary,
+                     },
+                     '&.Mui-focused fieldset': {
+                       borderColor: colors.primary,
+                     },
+                   },
+                   '& .MuiInputLabel-root.Mui-focused': {
+                     color: colors.primary,
+                   },
+                 }}
                />
```

</div>
<div>

**スタイリングのポイント**
- `borderRadius`: Paper と TextField に角丸を追加
- `background: colors.surface`: 背景色を設定
- `backdropFilter: 'blur(20px)'`: ガラスモーフィズム効果
- `border: '1px solid ...'`: 薄いボーダー
- `backgroundColor: 'rgba(255, 255, 255, 0.8)'`: 半透明の白背景
- `'&:hover fieldset'`: ホバー時の色変更
- `'&.Mui-focused fieldset'`: フォーカス時の色変更

</div>
</div>

---

## 2.3 テキスト入力状態の追加

<div grid="~ cols-2 gap-4">
<div>

```diff
+ import { useState, useCallback, type ChangeEvent } from 'react';
  import {
    Container,
    // ...
  } from '@mui/material';
- import type { Colors } from './types';
+ import type { Colors, Message } from './types';
  import './App.css';

  const App = () => {
    const theme = useTheme();
    const colors: Colors = {
      // 省略
    };

+   const [text, setText] = useState<string>('');
+   const [messages, setMessages] = useState<Message[]>([]);
+
+   const handleTextChange = useCallback(
+     (e: ChangeEvent<HTMLInputElement>): void => {
+       setText(e.target.value);
+     },
+     [],
+   );
```

</div>
<div>

```diff
// src/App.tsx
            <TextField
              label="今の気分はいかがでしょうか？"
              multiline
              fullWidth
              rows={4}
+             value={text}
+             onChange={handleTextChange}
            />
            <Fab
              color="primary"
              type="submit"
              size="large"
+             disabled={!text.trim()}
            >
              <SendIcon />
            </Fab>
```

📝 **`useCallback` の活用：**
- 関数をメモ化してパフォーマンス最適化
- 依存配列が空なので初回のみ生成

</div>
</div>

---

## 2.4 メッセージ投稿処理の実装

<div grid="~ cols-2 gap-4">
<div>

```diff
- import { useState, useCallback, type ChangeEvent } from 'react';
+ import { useState, useCallback, type ChangeEvent, type FormEvent } from 'react';
+ import { v4 as uuidv4 } from 'uuid';

  //（中略）

  const App = () => {
    const [text, setText] = useState<string>('');
    const [messages, setMessages] = useState<Message[]>([]);

    // 中略

+   const handlePost = useCallback(
+     (e: FormEvent<HTMLFormElement>): void => {
+       e.preventDefault();
+       // 空文字チェック
+       if (!text.trim()) {
+         return;
+       }
+       // 新しいメッセージオブジェクトを作成
+       const newMessage: Message = {
+         id: uuidv4(),
+         text: text.trim(),
+         date: new Date().toLocaleString(),
+       };
```

</div>
<div>

```diff
+       setMessages(prev => [newMessage, ...prev]);
+       setText('');
+     },
+     [text],
+   );

    return (
      // ... JSX
-     <form>
+     <form onSubmit={handlePost}>
        {/* TextField と Fab */}
      </form>
    );
  };
```

**送信処理のポイント**
- `useCallback` でメモ化してパフォーマンス向上
- 依存配列に `[text]` を指定
- `React.FormEvent<HTMLFormElement>` で型安全なイベント処理
- `e.preventDefault()` でページリロードを防止
- `uuidv4()` で一意な ID を生成

</div>
</div>

---

## 2.5 バリデーション機能の追加

<div grid="~ cols-2 gap-4">
<div>

```diff
+ const MAX_MESSAGE_LENGTH = 140;

  const App = () => {
    const [text, setText] = useState<string>('');
    const [messages, setMessages] = useState<Message[]>([]);

    // 中略

+   const validateMessage = (str: string): string => {
+     if (!str.trim()) {
+       return '内容を入力してください';
+     }
+     if (str.length > MAX_MESSAGE_LENGTH) {
+       return `${MAX_MESSAGE_LENGTH}文字以内で入力してください`;
+     }
+     return '';
+   };
```

</div>
<div>

```diff
    const handlePost = (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();

-     if (!text.trim()) {
-       return;
-     }

+     const errorMessage = validateMessage(text);
+     if (errorMessage) {
+       alert(errorMessage);
+       return;
+     }
```

**バリデーション実装**
- `validateMessage` 関数で入力チェック
- TypeScript の恩恵でエラーハンドリングが型安全

※バリデーション専用のライブラリ [zod](https://zod.dev/) などもあります

</div>
</div>

---

# 3. メッセージリスト表示機能の実装

## 3.1 リスト表示に必要なコンポーネントのインポート

<div grid="~ cols-2 gap-4">
<div>

```diff
// メッセージ表示が必要になったので追加インポート
import {
  Container,
  Typography,
  TextField,
  Stack,
  Button,
+ Card,
+ CardContent,
+ CardActions,
  Box,
  Paper,
+ Divider,
+ Chip,
} from '@mui/material';
import {
  Send as SendIcon,
+ Delete as DeleteIcon,
} from '@mui/icons-material';
```

</div>
<div>

**段階的なインポート**
- 最初から全部インポートせず、必要になったタイミングで追加
- `Card` 系：メッセージをカード形式で表示したくなった時
- `Chip`：日時表示をコンパクトにしたくなった時
- `DeleteIcon`：削除機能が必要になった時

</div>
</div>

---

## 3.2 基本的なメッセージリストの表示

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
// メッセージ投稿フォームの下に追加
+       {/* メッセージリスト */}
+       <Stack spacing={{ xs: 2, sm: 3 }}>
+         {messages.length === 0 ? (
+           <Paper
+             elevation={1}
+             sx={{
+               p: 4,
+               textAlign: 'center',
+               background: 'rgba(255, 255, 255, 0.7)',
+               borderRadius: 3,
+             }}
+           >
+             <Typography variant="h6" color="text.secondary" sx={{ mb: 1 }}>
+               📝 まだメッセージがありません
+             </Typography>
+             <Typography variant="body2" color="text.secondary">
+               上のフォームから最初のメッセージを投稿してみましょう！
+             </Typography>
+           </Paper>
```

</div>
<div>

```diff
// src/App.tsx
+         ) : (
+           <>
+             <Typography
+               variant="subtitle2"
+               color="text.secondary"
+               sx={{ mb: 2, textAlign: 'center' }}
+             >
+               {messages.length} 件のメッセージ
+             </Typography>
+             {messages.map((message: Message) => (
+               <Card key={message.id} elevation={3}>
+                 <CardContent sx={{ p: { xs: 2, sm: 3 } }}>
+                   <Typography variant="body1">
+                     {message.text}
+                   </Typography>
+                 </CardContent>
+               </Card>
+             ))}
+           </>
+         )}
+       </Stack>
```

</div>
</div>

---

## 3.2 基本的なメッセージリストの表示

<div grid="~ cols-2 gap-4">
<div>

**実装のポイント**
- 空状態の表示でユーザビリティ向上
- `map` で TypeScript の型安全なリストレンダリング
- `key={message.id}` で React のパフォーマンス最適化
- `messages.length` でメッセージ件数を表示
- レスポンシブなスペーシング（`xs: 2, sm: 3`）

</div>
<div>

**TypeScript のポイント**
- `messages.map((message: Message) => ...)` で型を明示
- 配列の型安全な操作
- `message.id` は `number` 型として安全に使用
- `message.text` は `string` 型として保証される

</div>
</div>

---


## 3.3 メッセージカードに日時を追加

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
              {messages.map((message: Message) => (
                <Card key={message.id} elevation={3}>
                  <CardContent sx={{ p: { xs: 2, sm: 3 } }}>
+                   <Box sx={{ mb: 2 }}>
+                     <Chip
+                       label={message.date}
+                       size="small"
+                       variant="outlined"
+                       sx={{
+                         height: 24,
+                         fontSize: '0.75rem',
+                         borderColor: colors.primary,
+                         color: colors.primary,
+                         backgroundColor: 'rgba(59, 130, 246, 0.05)',
+                       }}
+                     />
+                   </Box>
                    <Typography variant="body1">
                      {message.text}
                    </Typography>
```

</div>
<div>

**UI改善のポイント**
- `Chip` コンポーネントで日時を視覚的に強調
- `mb: 2` でメッセージ本文との間隔を確保
- `borderColor` と `color` でテーマカラーを適用
- `backgroundColor` で半透明背景を追加

</div>
</div>

---

## 3.4 日時表示の改善（相対時間関数の追加）

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
  const App = () => {
    const theme = useTheme();
    const colors: Colors = {
      primary: theme.palette.primary.main,
      surface: theme.palette.background.paper,
      gradient: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,
    };

    const [text, setText] = useState<string>('');
    const [messages, setMessages] = useState<Message[]>([]);

+   // 「◯分前」表示が欲しくなったので関数を追加
+   const formatRelativeTime = (date: string): string => {
+     const now = new Date();
+     const messageDate = new Date(date);
+     const diffInMinutes = Math.floor(
+       (now.getTime() - messageDate.getTime()) / (1000 * 60)
+     );
```

</div>
<div>

```diff
+     if (diffInMinutes < 1) return 'たった今';
+     if (diffInMinutes < 60) return `${diffInMinutes}分前`;
+
+     const diffInHours = Math.floor(diffInMinutes / 60);
+     if (diffInHours < 24) return `${diffInHours}時間前`;
+
+     const diffInDays = Math.floor(diffInHours / 24);
+     if (diffInDays < 7) return `${diffInDays}日前`;
+
+     return messageDate.toLocaleDateString();
+   };

// 中略

    <Chip
-     label={message.date}
+     label={formatRelativeTime(message.date)}
```

**機能拡張のポイント**
- 純粋関数として分離することで再利用性向上
- 「たった今」「◯分前」などのユーザーフレンドリーな表示
- 段階的な改善でコードの可読性を保つ

</div>
</div>

---

## 3.5 メッセージカードのスタイリング改善

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
              {messages.map((message: Message) => (
-               <Card key={message.id} elevation={3}>
+               <Card
+                 key={message.id}
+                 elevation={3}
+                 sx={{
+                   borderRadius: { xs: 2, sm: 3 },
+                   overflow: 'hidden',
+                   background: colors.surface,
+                   backdropFilter: 'blur(20px)',
+                   border: '1px solid rgba(59, 130, 246, 0.1)',
+                   transition: 'all 0.3s ease',
+                   '&:hover': {
+                     transform: 'translateY(-4px)',
+                     boxShadow: '0 12px 30px rgba(59, 130, 246, 0.15)',
+                   },
+                 }}
+               >
                  <CardContent sx={{ p: { xs: 2, sm: 3 } }}>
```

</div>
<div>

```diff
// src/App.tsx
                    <Typography
-                     variant="body1"
+                     variant="body1"
+                     component="p"
+                     sx={{
+                       lineHeight: 1.7,
+                       color: '#1f2937',
+                       fontSize: { xs: '0.95rem', sm: '1rem' },
+                       fontWeight: 400,
+                     }}
                    >
                      {message.text}
                    </Typography>
```

**スタイリングのポイント**
- ガラスモーフィズム効果（`backdropFilter: 'blur(20px)'`）
- ホバー時のアニメーション（上に浮く効果）

</div>
</div>

---

# 4. 削除機能とユーザビリティ向上

## 4.1 削除機能の実装

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
    const handlePost = useCallback(
      // 実装済み
    );

+   // 削除機能を追加
+   const deleteMessage = useCallback(
+     (id: string): void => {
+       const message = messages.find((m) => m.id === id);
+       if (!message) return;
+
+       const previewText =
+         message.text.length > 20
+           ? message.text.substring(0, 20) + '...'
+           : message.text;
+
+       if (window.confirm(`「${previewText}」を削除しますか？`)) {
+         setMessages((prev) => prev.filter((message) => message.id !== id));
+       }
+     },
+     [messages],
+   );
```

</div>
<div>

**削除機能のポイント**
- `useCallback` でメモ化
- 依存配列に `[messages]` を指定
- `find` メソッドで対象メッセージを安全に検索
- 20文字以上の場合は省略表示
- ユーザーフレンドリーな確認ダイアログ
- `filter` で immutable な配列更新

</div>
</div>

---

## 4.2 削除ボタンの追加

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
                    </Typography>
                  </CardContent>
+
+                 <Divider sx={{ borderColor: 'rgba(59, 130, 246, 0.1)' }} />
+
+                 <CardActions
+                   sx={{ justifyContent: 'flex-end', p: { xs: 1.5, sm: 2 } }}
+                 >
+                   <Button
+                     size="small"
+                     color="error"
+                     startIcon={<DeleteIcon />}
+                     onClick={() => deleteMessage(message.id)}
+                     sx={{
+                       borderRadius: 2,
+                       fontSize: { xs: '0.8rem', sm: '0.875rem' },
+                       '&:hover': {
+                         backgroundColor: 'rgba(244, 67, 54, 0.08)',
+                       },
+                     }}
+                   >
+                     削除
+                   </Button>
+                 </CardActions>
                </Card>
```

</div>
<div>

**UI構成のポイント**
- `Divider` でコンテンツとアクションを視覚的に分離
- `justifyContent: 'flex-end'` で右寄せ
- `color="error"` で削除を示す赤色
- `startIcon` でアイコンを追加
- ホバー時の背景色変更でフィードバック

</div>
</div>

---

## 4.3 ローディング状態の追加

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
  const App = () => {
    const [text, setText] = useState<string>('');
    const [messages, setMessages] = useState<Message[]>([]);
+   const [isPosting, setIsPosting] = useState<boolean>(false);

    const handlePost = (e: React.FormEvent<HTMLFormElement>) => {
      e.preventDefault();

      const error = validateMessage(text);
      if (error) {
        alert(error);
        return;
      }

+     setIsPosting(true);
+
+     try {
        const newMessage: Message = {
          id: uuidv4(),
          text: text.trim(),
          date: new Date().toLocaleString(),
        };
```

</div>
<div>

```diff
// src/App.tsx
        setMessages(prev => [newMessage, ...prev]);
        setText('');
+     } finally {
+       setIsPosting(false);
+     }
    };
```

**ローディング状態管理**
- `isPosting` で投稿中の状態を管理
- `try/finally` で確実な状態リセット
- ボタンの disabled 状態で二重送信防止
- UX 向上のための重要な実装

</div>
</div>

---

## 4.4 送信ボタンの状態反映

<div grid="~ cols-2 gap-4">
<div>

```diff
// src/App.tsx
              <Fab
                color="primary"
                type="submit"
                size="large"
-               disabled={!text.trim()}
+               disabled={!text.trim() || isPosting}
+               sx={{
+                 background:
+                   text.trim() && !isPosting ? colors.gradient : undefined,
+                 '&:hover': {
+                   background:
+                     text.trim() && !isPosting
+                       ? colors.gradientHover
+                       : undefined,
+                 },
+                 transition: 'all 0.3s ease',
+                 transform: text.trim() ? 'scale(1.05)' : 'scale(1)',
+               }}
              >
                <SendIcon />
              </Fab>
```

</div>
<div>

```diff
// src/main.tsx
    primary: {
      main: '#3B82F6',
+     dark: '#2563EB',
    },
    secondary: {
      main: '#10B981',
+     dark: '#059669',
    },
```

```diff
// src/App.tsx
  const colors: Colors = {
    primary: theme.palette.primary.main,
    surface: theme.palette.background.paper,
    gradient: `linear-gradient(135deg, ${theme.palette.primary.main} 0%, ${theme.palette.secondary.main} 100%)`,
+   gradientHover: `linear-gradient(135deg, ${theme.palette.primary.dark} 0%, ${theme.palette.secondary.dark} 100%)`,
  }
```

```diff
// src/types.ts
export type Colors = {
  primary: string;
  surface: string;
  gradient: string;
+ gradientHover: string;
};
```
</div>
</div>

---

# 5. 次回の予告


次回は TypeScript で画像アップロード機能を実装します：

- File API の型安全な使用方法
- 画像プレビュー機能の実装
- 画像付きメッセージの投稿
- ファイルバリデーションの追加
- 必要になった時点で `Message` 型に `image?` プロパティを追加

---
layout: section
---

# お疲れさまでした！ 🎉

## 次回は画像アップロード機能を作ります！